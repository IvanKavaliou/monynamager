<!DOCTYPE HTML>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:insert="fragments/general :: header"/>
</head>
<body>
<th:block th:insert="fragments/header :: header" />
<div class="row justify-content-center">
    <div class="col col-md-3">
        <div class="container">
            <div>
                <div class="container">
                    <div class="row">
                        <div class="col">
                            <h6>[[#{label.choiseCurrency}]]</h6>
                        </div>
                        <div class="col-5">
                            <select id="currencySelect" class="nice-select custom-select custom-select-sm">
                                <option th:each="currency : ${user.getUserCurrencys()}" th:value="${currency.currencyType}" th:text= "#{label.currency. + ${currency.currencyType}}"></option>
                            </select>
                        </div>
                        <div class="col-1">
                            <button type="button"  id="currencyAdd" class="btn btn-light btn-sm" data-toggle="modal" data-target="#addCurrencyModal">+</button>
                        </div>
                        <div class="col-1">
                            <button type="button" id="currencyDelete" class="btn btn-light btn-sm"  data-toggle="modal" data-target="#deleteCurrencyModal">-</button>
                        </div>
                    </div>
                    <div class="row">
                        <div id="currencyMessageAlert" class="alert alert-primary alert-dismissible collapse" role="alert">
                            <div id="currencyMessage"></div>
                            <button type="button" class="close"  data-hide="alert"><span aria-hidden="true">&times;</span></button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-2">
                <div class="container">
                    <div class="row">
                        <div class="col"><h3>[[#{label.expenses}]]</h3></div>
                        <div class="col"><button type="button" id="addExpensisButton" class="btn btn-light btn-sm open-AddDialog">+</button></div>
                    </div>
                    <div class="row ml-1">
                        <div class="col"><h6>[[#{label.today}]]</h6></div>
                        <div id="expenses_day" class="col"><h6>~~~~</h6></div>
                    </div>
                    <div class="row ml-1">
                        <div class="col"><h6>[[#{label.week}]]</h6></div>
                        <div id="expenses_week" class="col"><h6>~~~~</h6></div>
                    </div>
                    <div class="row ml-1">
                        <div class="col"><h6>[[#{label.mounth}]]</h6></div>
                        <div id="expenses_month" class="col"><h6>~~~~</h6></div>
                    </div>
                </div>
            </div>
            <div>
                <div class="container">
                    <div class="row">
                        <div class="col"><h3>[[#{label.income}]]</h3></div>
                        <div class="col"><button type="button" id="addIncomeButton" class="btn btn-light btn-sm open-AddDialog">+</button></div>
                    </div>
                    <div class="row ml-1">
                        <div class="col"><h6>[[#{label.today}]]</h6></div>
                        <div id="income_day" class="col"><h6>~~~~</h6></div>
                    </div>
                    <div class="row ml-1">
                        <div class="col"><h6>[[#{label.week}]]</h6></div>
                        <div id="income_week" class="col"><h6>~~~~</h6></div>
                    </div>
                    <div class="row ml-1">
                        <div class="col"><h6>[[#{label.mounth}]]</h6></div>
                        <div id="income_month" class="col"><h6>~~~~</h6></div>
                    </div>
                </div>
            </div>
            <div>
                <div class="container">
                    <div class="row">
                        <div class="col"><h3>[[#{label.balance}]]</h3></div>
                        <div id="balance" class="col"><h4>~~~~</h4></div>
                    </div>
                    <div class="row">

                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-auto">
        <div class="container">
            <div>
                <ul class="nav nav-tabs nav-fill">
                    <li class="nav-item"><a role="tab" data-toggle="tab" class="nav-link active" href="#tab-1">[[#{label.last}]]</a></li>
                    <li class="nav-item"><a role="tab" data-toggle="tab" class="nav-link" href="#tab-2">[[#{label.expenses}]]</a></li>
                    <li class="nav-item"><a role="tab" data-toggle="tab" class="nav-link" href="#tab-3">[[#{label.income}]]</a></li>
                </ul>
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="tab-1">
                        <table id="lastTable" class="display" style="width: 100%">
                            <thead>
                            <tr>
                                <th>[[#{label.date}]]</th>
                                <th>[[#{label.description}]]</th>
                                <th>[[#{label.value}]]</th>
                                <th>[[#{label.currency}]]</th>
                                <th>[[#{label.category}]]</th>
                                <th>[[#{label.type}]]</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="tab-2">
                        <table id="expensesTable" class="display" style="width: 100%">
                            <thead>
                            <tr>
                                <th>[[#{label.date}]]</th>
                                <th>[[#{label.description}]]</th>
                                <th>[[#{label.value}]]</th>
                                <th>[[#{label.currency}]]</th>
                                <th>[[#{label.category}]]</th>
                                <th>[[#{label.type}]]</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="tab-3">
                        <table id="incomeTable" class="display" style="width: 100%">
                            <thead>
                            <tr>
                                <th>[[#{label.date}]]</th>
                                <th>[[#{label.description}]]</th>
                                <th>[[#{label.value}]]</th>
                                <th>[[#{label.currency}]]</th>
                                <th>[[#{label.category}]]</th>
                                <th>[[#{label.type}]]</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- DELETE CURRENCY MODAL #####START##### -->
<div class="modal fade" id="deleteCurrencyModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel2" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteCurrencyModalTitle">[[#{currency.delete.title}]]</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                [[#{currency.delete.message}]]
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">[[#{button.close}]]</button>
                <button type="button" id="currencyDeleteSubmit" class="btn btn-primary">[[#{button.delete}]]</button>
            </div>
        </div>
    </div>
</div>
<!-- DELETE CURRENCY MODAL #####END##### -->
<!-- ADD CURRENCY MODAL #####START##### -->
<div class="modal fade" id="addCurrencyModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel2" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCurrencyModalTitle">[[#{currency.add.title}]]</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <p>[[#{currency.add.message}]]</p>
                <select id="currencyAddSelect" class="nice-select custom-select custom-select-sm">
                    <option th:each="currency : ${allCurrencys}" th:value="${currency.currencyType}" th:text= "#{label.currency. + ${currency.currencyType}}"></option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">[[#{button.close}]]</button>
                <button type="button" id="currencyAddSubmit" class="btn btn-primary">[[#{button.add}]]</button>
            </div>
        </div>
    </div>
</div>
<!-- ADD CURRENCY MODAL  #####END##### -->



<!-- Modal ADD EXSPENSES -->
<div class="modal fade" id="addTransModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="addTransModalTitle" class="modal-title" >Title</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">

             <form method="post" id="expensivAddFrom">

                        <div class="form-group">
                             <input id="trans_add_date" type="datetime-local" class="form-control">
                        </div>
                        <div class="form-group">
                            <h6>[[#{label.description}]]</h6>
                            <input id="trans_add_name" type="text" class="form-control" th:placeholder="#{label.description}" />
                        </div>
                        <div class="form-group">
                            <h6>[[#{label.value}]]</h6>
                            <input id="trans_add_value" type="number" class="form-control" th:placeholder="#{label.value}" />
                        </div>
                        <div class="form-group">
                            <h6>[[#{label.currency}]]</h6>
                            <select id="trans_add_currencyType" class="nice-select custom-select custom-select-sm">
                                <option th:each="currency : ${user.getUserCurrencys()}" th:value="${currency.getCurrencyType()}" th:text= "#{label.currency. + ${currency.currencyType}}"></option>
                            </select>
                        </div>
                        <div class="form-group">
                            <h6>[[#{label.category}]]</h6>
                            <select id="trans_add_idTransactionCategoryExp" class="nice-select custom-select custom-select-sm collapse">
                                <option th:each="category : ${expensesCategorys}" th:value="${category.getId()}" th:text= "${category.getName()}"></option>
                            </select>
                            <select id="trans_add_idTransactionCategoryInc" class="nice-select custom-select custom-select-sm collapse">
                                <option th:each="category : ${incomesCategorys}" th:value="${category.getId()}" th:text= "${category.getName()}"></option>
                            </select>
                        </div>
                         <input id="transType"  type="hidden">
                        <input id="transId"  type="hidden">

            </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">[[#{button.close}]]</button>
                            <button type="submit"  class="btn btn-primary">[[#{button.add}]]</button>
                        </div>
            </form>
        </div>
    </div>
</div>


<script>

    $(function(){
        $("[data-hide]").on("click", function(){
            $(this).closest("." + $(this).attr("data-hide")).hide();
        });
    });

    $('#currencySelect').change(function() {
        upAmounts($('#currencySelect').val());
    });

    function upAmounts(currency){
        $.ajax({
            url: "rest/amount/INCOME/" + currency
        }).then(function(data) {
            $('#income_day').html(data.day);
            $('#income_week').html(data.week);
            $('#income_month').html(data.month);
            $('#balance').html(data.balance);
        });

        $.ajax({
            url: "rest/amount/EXPENSES/" + currency
        }).then(function(data) {
            $('#expenses_day').html(data.day);
            $('#expenses_week').html(data.week);
            $('#expenses_month').html(data.month);
        });
    }

    $(document).ready( function () {
        function openTransModal(id, type) {
            $('#trans_add_name').removeClass('is-invalid');
            $('#trans_add_value').removeClass('is-invalid');
            $('#trans_add_date').removeClass('is-invalid');
            $('#currencySelectAdd').removeClass('is-invalid');
            $('#categorys').removeClass('is-invalid');

            $("#transId").val(id);
            $("#trans_add_name").val("");
            $("#trans_add_value").val("");
            $("#trans_add_date").val(new Date().toJSON().slice(0,16));

            if (type =="EXPENSES"){
                $("#addTransModalTitle").html("[[#{label.expenses}]]");
                $("#trans_add_idTransactionCategoryInc").collapse("hide");
                $('#trans_add_idTransactionCategoryExp').collapse("show");
                $("#transType").val("EXPENSES");
            }
            if(type == "INCOME"){
                $("#addTransModalTitle").html("[[#{label.income}]]");
                $("#trans_add_idTransactionCategoryInc").collapse("show");
                $('#trans_add_idTransactionCategoryExp').collapse("hide");
                $("#transType").val("INCOME");
            }

            $("#addTransModal").modal("show");
        }
        
        function editTrans(row) {
            openTransModal(row.id, row.transactionCategory.transactionType.transactionType);

            $("#trans_add_name").val(row.name);
            $("#trans_add_value").val(row.value);
            $('#trans_add_currencyType option[value='+row.currency.currencyType+']').attr('selected','selected');
            $("#trans_add_date").val(row.date.replace(" ","T"));

            if(row.transactionCategory.transactionType.transactionType == "EXPENSES"){
                $('#trans_add_idTransactionCategoryExp option[value='+row.transactionCategory.id+']').attr('selected','selected');
            }
            if(row.transactionCategory.transactionType.transactionType == "INCOME"){
                $('#trans_add_idTransactionCategoryInc option[value='+row.transactionCategory.id+']').attr('selected','selected');
            }
        }


        var table = $('#lastTable').DataTable({
            language: {
                url: "/dt_i18n/[[${#locale}]].lang"
            },
            "sAjaxSource": "rest/trnsactions",
            "sAjaxDataProp": "",
            "order": [ [ 0, "asc" ] ],
            "aoColumns": [
                { "data": "date"},
                { "data": "name" },
                { "data": "value" },
                { "data": "currency.currencyType"},
                { "data": "transactionCategory.name"},
                { "data": "transactionCategory.transactionType.transactionType"}
            ]
        });

        $('#lastTable tbody').on('click', 'tr', function () {
            editTrans(table.row(this).data());
        });

        var tableIncome = $('#incomeTable').DataTable({
            language: {
                url: "/dt_i18n/[[${#locale}]].lang"
            },
            "sAjaxSource": "rest/trnsactions/income",
            "sAjaxDataProp": "",
            "order": [ [ 0, "asc" ] ],
            "aoColumns": [
                { "data": "date"},
                { "data": "name" },
                { "data": "value" },
                { "data": "currency.currencyType"},
                { "data": "transactionCategory.name"},
                { "data": "transactionCategory.transactionType.transactionType"}
            ]
        });

        $('#incomeTable tbody').on('click', 'tr', function () {
            editTrans(tableIncome.row(this).data());
        });

        var tableExpenses = $('#expensesTable').DataTable({
            language: {
                url: "/dt_i18n/[[${#locale}]].lang"
            },
            "sAjaxSource": "rest/trnsactions/expenses",
            "sAjaxDataProp": "",
            "order": [ [ 0, "asc" ] ],
            "aoColumns": [
                { "data": "date"},
                { "data": "name" },
                { "data": "value" },
                { "data": "currency.currencyType"},
                { "data": "transactionCategory.name"},
                { "data": "transactionCategory.transactionType.transactionType"}
            ]
        });

        $('#expensesTable tbody').on('click', 'tr', function () {
            editTrans(tableExpenses.row(this).data());
        });

        upAmounts($('#currencySelect').val());

        $("#currencyDelete").click(function(){
            var cur = $('#currencySelect option:selected').html();
            $("#deleteCurrencyModalTitle").html('[[#{currency.delete.title}]] ('+ cur +')');
        });

        $("#currencyDeleteSubmit").click(function(){
            $.ajax({
                url: 'rest/currency/delete/' + $('#currencySelect').val(),
                type: 'GET',
                success: function(result) {
                    window.location.replace("/main");
                },
                error: function (result) {
                    $('#deleteCurrencyModal').modal('toggle');
                    $("#currencyMessageAlert").show();
                    $("#currencyMessage").html(result.responseJSON.message);
                }
            });
        });

        $("#currencyAddSubmit").click(function(){
            $.ajax({
                url: 'rest/currency/add/' + $('#currencyAddSelect').val(),
                type: 'GET',
                success: function(result) {
                    window.location.replace("/main");
                },
                error: function (result) {
                    $('#addCurrencyModal').modal('toggle');
                    $("#currencyMessageAlert").show();
                    $("#currencyMessage").html(result.responseJSON.message);
                }
            });
        });


        $("#addExpensisButton").click(function(){
            openTransModal(null, "EXPENSES");
        });
        $("#addIncomeButton").click(function(){
            openTransModal(null, "INCOME");
        });

    });

    $(function(){
        $("#expensivAddFrom").on("submit", function(event) {
            event.preventDefault();

            var formData;
            if($("#transType").val() == "EXPENSES"){
                 formData = {
                    'id': $("#transId").val(),
                    'name': $('#trans_add_name').val(),
                    'date' : $('#trans_add_date').val(),
                    'value' : $('#trans_add_value').val(),
                    'currencyType' : $('#trans_add_currencyType').val(),
                    'idTransactionCategory' : $('#trans_add_idTransactionCategoryExp').val()
                };
            }
            if($("#transType").val() =="INCOME"){
                formData = {
                    'id': $("#transId").val(),
                    'name': $('#trans_add_name').val(),
                    'date' : $('#trans_add_date').val(),
                    'value' : $('#trans_add_value').val(),
                    'currencyType' : $('#trans_add_currencyType').val(),
                    'idTransactionCategory' : $('#trans_add_idTransactionCategoryInc').val()
                };
            }


            $.ajax({
                url: "rest/transactions",
                type: "post",
                data: JSON.stringify(formData),
                contentType: 'application/json',
                dataType: 'json',
                success: function(d) {
                    window.location.replace("/main");
                },
                error: function (result) {
                    $(result.responseJSON.errors).each(function() {
                        if(this.field == 'idTransactionCategory'){
                            if($("#transType").val() == "EXPENSES"){
                                $('#trans_add_'+this.field+'Exp').addClass('is-invalid');
                            } else {
                                $('#trans_add_'+this.field+'Inc').addClass('is-invalid');
                            }
                        } else{
                            $('#trans_add_'+this.field).addClass('is-invalid');
                        }
                    });
                }
            });
        });
    })


</script>

<th:block th:insert="fragments/general :: footer"/>
</body>
</html>